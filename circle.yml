machine:
  pre:
    - sudo service postgresql stop
    - sudo apt-get purge -y postgresql*
    - sudo apt-get update
    - sudo apt-get install postgresql
    - sudo service postgresql start

database:
  override:
    - go get bitbucket.org/liamstask/goose/cmd/goose
    - |
      if [[ $CIRCLE_BRANCH = 'dev' ]]; then
        goose -env development up
      fi
      if [[ $CIRCLE_BRANCH = 'qa' ]]; then
        goose -env qa up
      fi
      if [[ $CIRCLE_BRANCH = 'master' ]]; then
        goose -env production up
      fi

test:
  override:
    - go generate && go build -v && go test ./api ./gruff -v && go vet

deployment:
  master:
    branch: master
    commands:
      - npm i -g up
      - up version
      - up
  qa:
    branch: qa
    commands:
      - npm i -g up
      - up version
      - up
  dev:
    branch: dev
    commands:
      - npm i -g up
      - up version
      - up
